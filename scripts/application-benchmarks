#!/bin/bash
set -e

CUR=$(pwd)
HYPERFINE="${CUR}/ci/tools/hyperfine/hyperfine"
INPUTS="${CUR}/aoc-inputs/2021"

echo "unpacking mattcl examples"
tar -xvf mattcl-examples/aoc2021-mattcl.tar.gz
mv aoc2021-mattcl mattcl

# inputs look like
# aoc-inputs/year/day/files
i=1
while [ $i -ne 26 ]
do
  padded=`printf %03d $i`
  input_dir="${INPUTS}/day_${padded}"

  if [ ! -d "${input_dir}" ]; then
    echo "no inputs for day ${i}, breaking"
    break
  fi

  input_list=$(find "${input_dir}" -name "input-*" -exec basename {} \; | xargs | sed 's/ /,/g')
  echo "detected the following inputs for day ${i}: ${input_list}"

  var_prefix="AOC_INPUT=${input_dir}"

  cmd=(
    $HYPERFINE
    -w 3
    -n "day_${padded}-{fname}"
    -L fname $input_list
    --export-markdown "bench-${padded}.md"
  )
  # get the list of "executables"
  candidate=$(find mattcl -name "${padded}_*")
  if [ ! -z candidate ]; then
    cmd+=("${var_prefix}/{fname} ${candidate}")
  fi

  declare -p cmd

  echo "Benching day ${i}"
  "${cmd[@]}"

  i=`expr $i + 1`
done
