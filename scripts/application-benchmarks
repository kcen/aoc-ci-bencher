#!/bin/bash
set -e

CUR=$(pwd)
HYPERFINE="${CUR}/ci/tools/hyperfine/hyperfine"
INPUTS="${CUR}/aoc-inputs/2021"

# make the working repo
git clone aoc-inputs modified-aoc-inputs

echo "unpacking mattcl examples"
tar -xvf mattcl-examples/aoc2021-mattcl.tar.gz
mv aoc2021-mattcl mattcl

echo "unpacking lanjian examples"
tar -xvf lanjian-examples/aoc-2021-lanjian.tar.gz
mv aoc-2021-lanjian lanjian

# inputs look like
# aoc-inputs/year/day/files
i=1
while [ $i -ne 26 ]
do
  echo ""
  echo "--- Preparing environment for day ${i} ---"

  padded=`printf %03d $i`
  input_dir="${INPUTS}/day_${padded}"

  if [ ! -d "${input_dir}" ]; then
    echo "no inputs for day ${i}, breaking"
    break
  fi

  input_list=$(find "${input_dir}" -name "input-*" -exec basename {} \; | xargs | sed 's/ /,/g')
  echo "detected the following inputs for day ${i}: ${input_list}"

  var_prefix="AOC_INPUT=${input_dir}"

  mkdir -p reports
  output="reports/bench-${padded}.md"
  large_output="reports/bench-large-${padded}.md"

  # get the list of "executables"
  mattcl_candidate=$(find mattcl -name "${padded}_*")

  short_padded=`printf %02d $i`
  lanjian_candidate=$(find lanjian -name "day_${short_padded}")

  nathanwang2_candidate=$(find nathanwang2 -maxdepth 1 -type d -name "day${i}")

  # normal benchmarks
  export INPUT_DIR=$input_dir
  cmd=(
    $HYPERFINE
    -w 3
    -L fname $input_list
    --export-markdown "$output"
  )
  if [ ! -z $mattcl_candidate ]; then
    cmd+=("ci/scripts/run-example ${mattcl_candidate} {fname}")
  fi

  if [ ! -z $lanjian_candidate ]; then
    cmd+=("ci/scripts/run-example ${lanjian_candidate} {fname}")
  fi

  if [ ! -z $nathanwang2_candidate ]; then
    # for now, just run the example they have, but later we need to parametrize
    # but this requires work from the repo owner
    cmd+=("ci/scripts/run-nathanwang2-example ${nathanwang2_candidate} {fname}")
  fi

  echo "Benching day ${i}"
  "${cmd[@]}"

  echo "Cleaning output file"
  sed -i 's/ci\/scripts\/run.*-example //g' $output

  cp $output "modified-aoc-inputs/2021/day_${padded}/application-benches.md"

  # large benchmarks
  large_input_list=$(find "${input_dir}" -name "large-input-*" -exec basename {} \; | xargs | sed 's/ /,/g')
  if [ ! -z $large_input_list ]; then
    echo "detected the following large inputs for day ${i}: ${large_input_list}"

    # for large benchmarks, we have to ignore failure
    cmd=(
      $HYPERFINE
      -w 3
      -L fname $large_input_list
      --ignore-failure
      --export-markdown "$large_output"
    )
    if [ ! -z $mattcl_candidate ]; then
      cmd+=("ci/scripts/run-example ${mattcl_candidate} {fname}")
    fi

    if [ ! -z $lanjian_candidate ]; then
      cmd+=("ci/scripts/run-example ${lanjian_candidate} {fname}")
    fi

    if [ ! -z $nathanwang2_candidate ]; then
      # for now, just run the example they have, but later we need to parametrize
      # but this requires work from the repo owner
      cmd+=("ci/scripts/run-nathanwang2-example ${nathanwang2_candidate} {fname}")
    fi

    echo "Benching day ${i} with large inputs"
    "${cmd[@]}"

    echo "Cleaning output file"
    sed -i 's/ci\/scripts\/run.*-example //g' $large_output

    cp $output "modified-aoc-inputs/2021/day_${padded}/application-large-benches.md"
  fi

  i=`expr $i + 1`
done

# stupidly commit the latest report, because who needs an easy to view history?
cd modified-aoc-inputs
git config --global user.name "papercode ci"
git config --global user.email "matt@questionable.engineering"
git add .
if [ -z "$(git status --porcelain)" ]; then
  echo "Working directory clean"
else
  git commit -a -m "automated: update benchmark reports"
fi
